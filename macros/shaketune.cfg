########################################
# Shake&Tune Service Macros for K1
########################################
#
# These macros run resonance tests and upload results to a local
# Shake&Tune service for analysis. Graphs are generated off-printer
# to avoid CPU limitations.
#
# SETUP:
# 1. Run the shaketune-service Docker container on your local network
# 2. Set SHAKETUNE_HOST below to your Docker host's IP address
# 3. Include this file in your printer.cfg
#
# USAGE:
# - SHAKETUNE_SHAPER: Full input shaper calibration with graphs
# - SHAKETUNE_BELTS: Belt tension comparison
# - SHAKETUNE_VIBRATIONS: Speed-based vibration analysis
#
########################################

[gcode_macro _SHAKETUNE_CONFIG]
description: Configuration for Shake&Tune service
# CHANGE THIS to your Docker host IP address
variable_host: "192.168.1.100"
variable_port: "8080"
gcode:
  # This macro just holds configuration variables


[gcode_shell_command shaketune_upload_shaper]
command: sh -c 'HOST=$(grep -o "variable_host:.*" /usr/data/printer_data/config/shaketune.cfg 2>/dev/null | cut -d\" -f2 || echo "192.168.1.100"); PORT=$(grep -o "variable_port:.*" /usr/data/printer_data/config/shaketune.cfg 2>/dev/null | cut -d\" -f2 || echo "8080"); RESULT=$(curl -s -X POST "http://${HOST}:${PORT}/shaper" -F "files=@/tmp/raw_data_x_x.csv" -F "files=@/tmp/raw_data_y_y.csv" 2>/dev/null); URL=$(echo "$RESULT" | grep -o "\"url\":\"[^\"]*\"" | cut -d\" -f4); echo "==========================================="; echo "SHAPER GRAPH: http://${HOST}:${PORT}${URL}"; echo "==========================================="'
timeout: 120
verbose: True


[gcode_shell_command shaketune_upload_belts]
command: sh -c 'HOST=$(grep -o "variable_host:.*" /usr/data/printer_data/config/shaketune.cfg 2>/dev/null | cut -d\" -f2 || echo "192.168.1.100"); PORT=$(grep -o "variable_port:.*" /usr/data/printer_data/config/shaketune.cfg 2>/dev/null | cut -d\" -f2 || echo "8080"); RESULT=$(curl -s -X POST "http://${HOST}:${PORT}/belts" -F "files=@/tmp/raw_data_axis=1.000,-1.000_a.csv" -F "files=@/tmp/raw_data_axis=1.000,1.000_b.csv" 2>/dev/null); URL=$(echo "$RESULT" | grep -o "\"url\":\"[^\"]*\"" | cut -d\" -f4); echo "==========================================="; echo "BELTS GRAPH: http://${HOST}:${PORT}${URL}"; echo "==========================================="'
timeout: 120
verbose: True


[gcode_macro SHAKETUNE_SHAPER]
description: Run input shaper calibration and generate analysis graph
gcode:
  {% set config = printer["gcode_macro _SHAKETUNE_CONFIG"] %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND MSG="Homing..."
    G28
  {% endif %}

  # Center the toolhead
  G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} Z50 F6000

  RESPOND MSG="Testing X axis resonances..."
  TEST_RESONANCES AXIS=X OUTPUT=raw_data NAME=x
  M400

  RESPOND MSG="Testing Y axis resonances..."
  TEST_RESONANCES AXIS=Y OUTPUT=raw_data NAME=y
  M400

  RESPOND MSG="Uploading to Shake&Tune service..."
  RUN_SHELL_COMMAND CMD=shaketune_upload_shaper

  RESPOND MSG="Analysis complete! Check console for graph URL."


[gcode_macro SHAKETUNE_BELTS]
description: Run belt comparison test and generate analysis graph
gcode:
  {% set config = printer["gcode_macro _SHAKETUNE_CONFIG"] %}
  {% set min_freq = params.FREQ_START|default(5)|float %}
  {% set max_freq = params.FREQ_END|default(133.33)|float %}
  {% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND MSG="Homing..."
    G28
  {% endif %}

  # Center the toolhead
  G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} Z50 F6000

  RESPOND MSG="Testing Belt A (1,-1)..."
  TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
  M400

  RESPOND MSG="Testing Belt B (1,1)..."
  TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
  M400

  RESPOND MSG="Uploading to Shake&Tune service..."
  RUN_SHELL_COMMAND CMD=shaketune_upload_belts

  RESPOND MSG="Analysis complete! Check console for graph URL."


[gcode_macro SHAKETUNE_EXCITE]
description: Vibrate at a specific frequency to locate resonance sources
gcode:
  {% set frequency = params.FREQUENCY|default(25)|int %}
  {% set duration = params.DURATION|default(10)|int %}
  {% set axis = params.AXIS|default("x")|string|lower %}

  {% if axis == "a" %}
    {% set axis = "1,-1" %}
  {% elif axis == "b" %}
    {% set axis = "1,1" %}
  {% endif %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND MSG="Homing..."
    G28
  {% endif %}

  G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} Z50 F6000

  RESPOND MSG="Exciting {axis} axis at {frequency}Hz for {duration}s..."
  TEST_RESONANCES OUTPUT=raw_data AXIS={axis} FREQ_START={frequency - 1} FREQ_END={frequency + 1} HZ_PER_SEC={1 / (duration / 3)}
  M400
  RESPOND MSG="Done."
